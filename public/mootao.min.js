Request.Contao=new Class({Extends:Request.JSON,options:{followRedirects:!0,url:window.location.href},initialize:function(t){t&&!t.url&&t.field&&t.field.form&&t.field.form.action&&(this.options.url=t.field.form.action),this.parent(t)},success:function(t){var e,i=this.getHeader("X-Ajax-Location");if(i&&this.options.followRedirects)location.replace(i);else{try{e=this.response.json=JSON.decode(t,this.options.secure)}catch(i){e={content:t}}null===e?e={content:""}:"object"!=typeof e&&(e={content:t}),""!=e.content&&(e.content=e.content.stripScripts((function(t){e.javascript=t.replace(/<!--|\/\/-->|<!\[CDATA\[\/\/>|<!]]>/g,"")})),e.javascript&&this.options.evalScripts&&Browser.exec(e.javascript)),this.onSuccess(e.content,e)}},failure:function(){var t=this.getHeader("X-Ajax-Location");t&&this.options.followRedirects&&this.status>=300&&this.status<400?location.replace(t):this.onFailure()}}),Class.refactor(Drag,{attach:function(){return this.handles.addEvent("touchstart",this.bound.start),this.previous.apply(this,arguments)},detach:function(){return this.handles.removeEvent("touchstart",this.bound.start),this.previous.apply(this,arguments)},start:function(){document.addEvents({touchmove:this.bound.check,touchend:this.bound.cancel}),this.previous.apply(this,arguments)},check:function(t){this.options.preventDefault&&t.preventDefault(),Math.round(Math.sqrt(Math.pow(t.page.x-this.mouse.start.x,2)+Math.pow(t.page.y-this.mouse.start.y,2)))>this.options.snap&&(this.cancel(),this.document.addEvents({mousemove:this.bound.drag,mouseup:this.bound.stop}),document.addEvents({touchmove:this.bound.drag,touchend:this.bound.stop}),this.fireEvent("start",[this.element,t]).fireEvent("snap",this.element))},cancel:function(){return document.removeEvents({touchmove:this.bound.check,touchend:this.bound.cancel}),this.previous.apply(this,arguments)},stop:function(){return document.removeEvents({touchmove:this.bound.drag,touchend:this.bound.stop}),this.previous.apply(this,arguments)}}),Class.refactor(Sortables,{initialize:function(t,e){return e.dragOptions=Object.merge(e.dragOptions||{},{preventDefault:e.dragOptions&&e.dragOptions.preventDefault||Browser.Features.Touch}),void 0===e.dragOptions.unDraggableTags&&(e.dragOptions.unDraggableTags=this.options.unDraggableTags.filter((function(t){return"button"!=t}))),this.previous.apply(this,arguments)},addItems:function(){return Array.flatten(arguments).each((function(t){this.elements.push(t);var e=t.retrieve("sortables:start",function(e){this.start.call(this,e,t)}.bind(this));(this.options.handle&&t.getElement(this.options.handle)||t).addEvents({mousedown:e,touchstart:e})}),this),this},removeItems:function(){return $$(Array.flatten(arguments).map((function(t){this.elements.erase(t);var e=t.retrieve("sortables:start");return(this.options.handle&&t.getElement(this.options.handle)||t).removeEvents({mousedown:e,touchend:e}),t}),this))},getClone:function(t,e){if(!this.options.clone)return new Element(e.tagName).inject(document.body);if("function"==typeOf(this.options.clone))return this.options.clone.call(this,t,e,this.list);var i=this.previous.apply(this,arguments);return i.addEvent("touchstart",(function(t){e.fireEvent("touchstart",t)})),i}}),Class.refactor(Request.Queue,{onComplete:function(){this.fireEvent("complete",arguments)},onCancel:function(){this.options.autoAdvance&&!this.error&&this.resume(),this.fireEvent("cancel",arguments)},onSuccess:function(){this.options.autoAdvance&&!this.error&&this.resume(),this.fireEvent("success",arguments),this.queue.length||this.isRunning()||this.fireEvent("end")},onFailure:function(){this.error=!0,!this.options.stopOnFailure&&this.options.autoAdvance&&this.resume(),this.fireEvent("failure",arguments),this.queue.length||this.isRunning()||this.fireEvent("end")},onException:function(){this.error=!0,!this.options.stopOnFailure&&this.options.autoAdvance&&this.resume(),this.fireEvent("exception",arguments)}}),Contao.SerpPreview=new Class({options:{id:0,trail:null,titleField:null,titleFallbackField:null,aliasField:null,descriptionField:null,descriptionFallbackField:null,titleTag:null},shorten:function(t,e){return t.length<=e?t:t.substr(0,t.lastIndexOf(" ",e))+" …"},html2string:function(t){return(new DOMParser).parseFromString(t,"text/html").body.textContent},getTinymce:function(){if(window.tinyMCE&&this.options.descriptionFallbackField)return window.tinyMCE.get(this.options.descriptionFallbackField)},initialize:function(){this.options=Object.merge.apply(null,[{},this.options].append(arguments));var t=$("serp_title_"+this.options.id),e=$("serp_url_"+this.options.id),i=$("serp_description_"+this.options.id),n=$(this.options.titleField),s=$(this.options.titleFallbackField),o=$(this.options.aliasField),r=$(this.options.descriptionField),a=$(this.options.descriptionFallbackField),h=-1===this.options.trail.indexOf("›"),l=this.options.titleTag||"%s";n&&n.addEvent("input",function(){n.value?t.set("text",this.shorten(l.replace(/%s/,n.value).replace(/%%/g,"%").replace(/\[-\]/g,"­").replace(/\[nbsp\]/g," "),64)):s&&s.value?t.set("text",this.shorten(this.html2string(l.replace(/%s/,s.value)).replace(/%%/g,"%").replace(/\[-\]/g,"­").replace(/\[nbsp\]/g," "),64)):t.set("text","")}.bind(this)),s&&s.addEvent("input",function(){n&&n.value||t.set("text",this.shorten(this.html2string(l.replace(/%s/,s.value)).replace(/%%/g,"%").replace(/\[-\]/g,"­").replace(/\[nbsp\]/g," "),64))}.bind(this)),o&&o.addEvent("input",function(){"index"==o.value&&h?e.set("text",this.options.trail):e.set("text",this.options.trail+" › "+(o.value||this.options.id).replace(/\//g," › "))}.bind(this)),r&&r.addEvent("input",function(){if(r.value)i.set("text",this.shorten(r.value,160));else{var t=this.getTinymce();t?i.set("text",this.shorten(this.html2string(t.getContent()),160)):a&&a.value?i.set("text",this.shorten(this.html2string(a.value),160)):i.set("text","")}}.bind(this)),a&&a.addEvent("input",function(){r&&r.value||i.set("text",this.shorten(this.html2string(a.value),160))}.bind(this)),setTimeout(function(){var t=this.getTinymce();t&&t.on("keyup",function(){r&&r.value||i.set("text",this.shorten(this.html2string(window.tinyMCE.activeEditor.getContent()),160))}.bind(this))}.bind(this),4)}});